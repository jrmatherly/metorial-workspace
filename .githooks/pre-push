#!/usr/bin/env bash
# Drift pre-push hook - runs quality gate checks before pushing
# Install: git config core.hooksPath .githooks

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}ðŸš€ Running Drift pre-push quality gates...${NC}"

# Check if drift is available
if ! command -v drift &> /dev/null; then
    echo -e "${YELLOW}âš ï¸  Drift not found, skipping pre-push checks${NC}"
    echo "   Install with: mise install npm:driftdetect"
    exit 0
fi

# Get the current branch
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Read from stdin for the push info
while read local_ref local_sha remote_ref remote_sha; do
    # Only run full gate on pushes to main/master/develop
    if [[ "$remote_ref" =~ (refs/heads/main|refs/heads/master|refs/heads/develop) ]]; then
        echo -e "${YELLOW}Pushing to protected branch, running full quality gate...${NC}"

        if drift gate --fail-on warning 2>/dev/null; then
            echo -e "${GREEN}âœ“ Quality gate passed${NC}"
        else
            EXIT_CODE=$?
            echo -e "${RED}âœ— Quality gate failed${NC}"
            echo ""
            echo "Run 'drift gate --verbose' for details"
            echo "Or use 'git push --no-verify' to bypass (not recommended)"
            exit $EXIT_CODE
        fi
    else
        # For feature branches, run lighter checks
        echo -e "${YELLOW}Feature branch push, running incremental checks...${NC}"

        if drift gate --fail-on error 2>/dev/null; then
            echo -e "${GREEN}âœ“ Quality checks passed${NC}"
        else
            EXIT_CODE=$?
            echo -e "${RED}âœ— Quality checks failed${NC}"
            echo ""
            echo "Run 'drift gate --verbose' for details"
            exit $EXIT_CODE
        fi
    fi
done

exit 0
