#:schema ./schema/mise.json
# Metorial Workspace Configuration
# https://mise.jdx.dev/configuration.html

min_version = "2026.1.0"

# ============================================================================
# WORKSPACE CONFIGURATION
# ============================================================================
# This is a polyrepo workspace - all mise tasks are centrally defined here.
# Sub-repos (metorial, metorial-platform, etc.) don't have their own mise configs.

[settings]
experimental = true  # Enable MCP server for AI assistants

# ============================================================================
# HOOKS - Automatic Environment Setup
# ============================================================================
[hooks]
# Auto-install tools when entering workspace directory
# This ensures all developers have correct tool versions automatically
# Also configures git hooks for the workspace (Drift checks, conventional commits)
enter = "mise install -q && git config --local core.hooksPath .githooks 2>/dev/null || true"

# ============================================================================
# PREPARE - Auto-Dependency Management
# ============================================================================
# Automatically install dependencies when lockfiles change
# Runs before `mise run` or `mise x` when auto = true
# Run `mise prep` manually to install all dependencies

[prepare.bun-platform]
auto = true
dir = "metorial-platform"
sources = ["metorial-platform/bun.lock"]
outputs = ["metorial-platform/node_modules/"]
run = "bun install"
description = "Install platform dependencies when lockfile changes"

[prepare.bun-catalog]
auto = true
dir = "metorial"
sources = ["metorial/bun.lock"]
outputs = ["metorial/node_modules/"]
run = "bun install"
description = "Install catalog dependencies when lockfile changes"

[prepare.bun-index]
auto = true
dir = "metorial-index"
sources = ["metorial-index/bun.lock"]
outputs = ["metorial-index/node_modules/"]
run = "bun install"
description = "Install index dependencies when lockfile changes"

[env]
# Workspace identification
METORIAL_WORKSPACE = "true"
# Enable mise experimental features (required for monorepo support)
MISE_EXPERIMENTAL = "1"

[tools]
# Node.js 24 LTS "Krypton" - platform frontend and services (EOL: April 2028)
node = "24"
# Bun 1.3.x - platform runtime and package management (acquired by Anthropic Dec 2025)
bun = "1.3"
# Go 1.24 - mcp-engine (latest stable as of Jan 2026)
go = "1.24"
# Yarn - metorial catalog package manager
yarn = "1"
# Multi-repo git operations (via pipx backend)
# Provides async batch git operations, visual status, and group management
"pipx:gita" = "latest"
# Markdown linting
"npm:markdownlint-cli" = "latest"
# Drift - Codebase intelligence for AI agents
# Provides pattern detection, call graph analysis, and AI context curation
"npm:driftdetect" = "latest"
"npm:driftdetect-mcp" = "latest"
"npm:driftdetect-dashboard" = "latest"
# Go linting tool for mcp-engine
golangci-lint = "latest"
# Changelog generation from git history (Conventional Commits)
# https://git-cliff.org/docs/
"aqua:orhun/git-cliff" = "latest"

# ============================================================================
# TASK CONFIGURATION
# ============================================================================
[task_config]
# Additional task directories
includes = [".mise/tasks"]

# ============================================================================
# PLATFORM TASKS (metorial-platform)
# ============================================================================
[tasks."platform:install"]
description = "Install platform dependencies"
dir = "metorial-platform"
run = "bun install"

[tasks."platform:build"]
description = "Build all platform packages"
dir = "metorial-platform"
run = "bun run build"
depends = ["platform:install"]

[tasks."platform:dev"]
description = "Start platform development servers"
dir = "metorial-platform"
run = "bun run dev"

[tasks."platform:test"]
description = "Run platform tests"
dir = "metorial-platform"
run = "bun run test"

[tasks."platform:prisma:generate"]
description = "Generate Prisma client"
dir = "metorial-platform"
run = "bun run prisma:generate"

[tasks."platform:prisma:push"]
description = "Push Prisma schema to database"
dir = "metorial-platform"
run = "bun run prisma:push"

[tasks."platform:client:generate"]
description = "Generate API clients"
dir = "metorial-platform"
run = "bun run client:generate"

# ============================================================================
# MCP ENGINE TASKS (Go - wrapping Makefile)
# ============================================================================
[tasks."engine:build"]
description = "Build unified MCP engine binary"
dir = "metorial-platform/src/mcp-engine"
run = "make build-unified"

[tasks."engine:dev"]
description = "Start MCP engine with hot reload (air)"
dir = "metorial-platform/src/mcp-engine"
run = "make dev"

[tasks."engine:test"]
description = "Run MCP engine tests"
dir = "metorial-platform/src/mcp-engine"
run = "make test"

[tasks."engine:lint"]
description = "Run Go linters on MCP engine"
dir = "metorial-platform/src/mcp-engine"
run = "make lint"

[tasks."engine:vet"]
description = "Run go vet on MCP engine"
dir = "metorial-platform/src/mcp-engine"
run = "make vet"

[tasks."engine:proto"]
description = "Generate protobuf files"
dir = "metorial-platform/src/mcp-engine"
run = "make proto"

# ============================================================================
# CATALOG TASKS (metorial)
# ============================================================================
[tasks."catalog:add-server"]
description = "Add a new MCP server to the catalog"
dir = "metorial"
run = "bun run add-server"

[tasks."catalog:build"]
description = "Build a specific MCP server (requires serverId)"
dir = "metorial"
run = "bun run build single $1"
usage = 'arg "<serverId>" help="Server ID to build (e.g., github)"'

[tasks."catalog:build-all"]
description = "Build all MCP servers (requires Docker)"
dir = "metorial"
run = "bun run build all"

[tasks."catalog:check-versions"]
description = "Check version consistency across servers"
dir = "metorial"
run = "bun run check-versions"

# ============================================================================
# DOCS TASKS (metorial-docs)
# ============================================================================
[tasks."docs:dev"]
description = "Start Mintlify documentation server"
dir = "metorial-docs"
run = "mint dev"

[tasks."docs:build"]
description = "Build documentation site"
dir = "metorial-docs"
run = "mint build"

# ============================================================================
# INDEX TASKS (metorial-index)
# ============================================================================
[tasks."index:build"]
description = "Build server index"
dir = "metorial-index"
run = "bun run build"

# ============================================================================
# WORKSPACE-LEVEL TASKS
# ============================================================================
[tasks.install]
description = "Install all workspace dependencies"
depends = ["platform:install"]
run = "echo 'All dependencies installed'"

[tasks.build]
description = "Build entire workspace (excludes catalog Docker builds)"
depends = ["platform:build", "engine:build"]
run = "echo 'Full workspace build complete'"

[tasks."build:full"]
description = "Build entire workspace including catalog (requires Docker)"
depends = ["platform:build", "catalog:build-all", "engine:build"]
run = "echo 'Full workspace build with catalog complete'"

[tasks.dev]
description = "Start all development servers"
depends = ["platform:dev"]
run = "echo 'Development servers started'"

[tasks.test]
description = "Run all tests"
depends = ["platform:test", "engine:test"]
run = "echo 'All tests complete'"

[tasks.lint]
description = "Run all linters"
depends = ["engine:lint"]
run = "echo 'Linting complete'"

# ============================================================================
# DRIFT TASKS - Codebase Intelligence for AI
# ============================================================================
# Drift scans your code, learns your patterns, and provides context to AI agents
# Documentation: https://github.com/dadbodgeoff/drift/wiki
#
# All Drift tasks are defined as file-based tasks in .mise/tasks/drift/
# Run `mise tasks | grep drift` to see available tasks
# Common tasks: drift:scan, drift:status, drift:gate, drift:dashboard
#
# Per-project operations use the (cd project && drift ...) pattern
# Project names: "MCP Catalog", "Platform", "MCP Engine", "Index Registry"

[tasks."drift:init"]
description = "Initialize Drift in a repository"
run = "drift init --yes"

# ============================================================================
# CHANGELOG TASKS - Automated changelog generation via git-cliff
# ============================================================================
# Documentation: https://git-cliff.org/docs/
# Uses Conventional Commits: https://www.conventionalcommits.org/

[tasks."changelog:generate"]
description = "Generate/update workspace changelog"
run = "git cliff -o CHANGELOG.md"

[tasks."changelog:preview"]
description = "Preview changelog changes (dry run)"
run = "git cliff --unreleased --strip header"

[tasks."changelog:latest"]
description = "Show changelog for latest release only"
run = "git cliff --latest --strip header"

[tasks."changelog:platform"]
description = "Generate changelog for metorial-platform"
run = '''
git cliff \
  --include-path "metorial-platform/**/*" \
  --github-repo "jrmatherly/metorial-platform" \
  -o metorial-platform/CHANGELOG.md
'''

[tasks."changelog:catalog"]
description = "Generate changelog for metorial catalog"
run = '''
git cliff \
  --include-path "metorial/**/*" \
  --github-repo "jrmatherly/metorial" \
  -o metorial/CHANGELOG.md
'''

[tasks."changelog:index"]
description = "Generate changelog for metorial-index"
run = '''
git cliff \
  --include-path "metorial-index/**/*" \
  --github-repo "jrmatherly/metorial-index" \
  -o metorial-index/CHANGELOG.md
'''

[tasks."changelog:engine"]
description = "Generate changelog for mcp-engine"
run = '''
git cliff \
  --include-path "metorial-platform/src/mcp-engine/**/*" \
  --github-repo "jrmatherly/metorial-platform" \
  -o metorial-platform/src/mcp-engine/CHANGELOG.md
'''

[tasks."changelog:all"]
description = "Generate changelogs for all projects"
depends = ["changelog:generate", "changelog:platform", "changelog:catalog", "changelog:index"]
run = "echo 'All changelogs generated'"

[tasks."changelog:release"]
description = "Generate release notes for latest tag"
run = "git cliff --latest --strip header -o RELEASE_NOTES.md"

[tasks."changelog:bump"]
description = "Calculate next semantic version based on commits"
run = "git cliff --bumped-version"

[tasks."changelog:validate"]
description = "Validate recent commits follow conventional format"
run = '''
echo "Checking recent commits for conventional format..."
git cliff --unreleased 2>&1 | head -50
echo ""
echo "✓ Changelog preview generated successfully"
'''

# ============================================================================
# MULTI-REPO GIT OPERATIONS (via gita)
# ============================================================================
# These tasks wrap gita commands for team standardization and discoverability
# gita is installed via mise's pipx backend (see [tools] section)

[tasks."git:status"]
description = "Show visual status of all repositories (via gita)"
run = "gita ll"
alias = "gs"

[tasks."git:fetch"]
description = "Fetch all repositories asynchronously (via gita)"
run = "gita fetch"
alias = "gf"

[tasks."git:pull"]
description = "Pull all repositories (via gita)"
run = "gita pull"
alias = "gp"
confirm = "This will pull changes in all repositories. Continue?"

[tasks."git:push"]
description = "Push all repositories (via gita)"
run = "gita push"
confirm = "This will push changes in all repositories. Continue?"

[tasks."git:branches"]
description = "Show branches across all repositories"
run = "gita branch"

[tasks."git:checkout"]
description = "Checkout branch in all repositories"
run = "gita super checkout $1"
usage = 'arg "<branch>" help="Branch name to checkout"'

[tasks."git:stash"]
description = "Stash changes in all repositories"
run = "gita super stash"

[tasks."git:stash-pop"]
description = "Pop stashed changes in all repositories"
run = "gita super stash pop"

[tasks."git:hooks:install"]
description = "Install git hooks for conventional commits and Drift checks"
run = '''
git config --local core.hooksPath .githooks
echo "✓ Git hooks installed from .githooks/"
echo "  - pre-commit: Drift pattern checks on staged files"
echo "  - pre-push: Quality gate before pushing"
echo "  - commit-msg: Conventional commit format validation"
'''

[tasks."git:hooks:uninstall"]
description = "Uninstall git hooks (revert to default .git/hooks)"
run = '''
git config --local --unset core.hooksPath
echo "✓ Git hooks uninstalled (using default .git/hooks)"
'''

# ============================================================================
# SHELL ALIASES
# ============================================================================
# Quick shortcuts when mise shell integration is active
# Usage: Type alias directly in shell (e.g., `mdev` instead of `mise run dev`)

[shell_alias]
# Workspace shortcuts
mdev = "mise run dev"
mbuild = "mise run build"
mtest = "mise run test"
mstatus = "mise run status"
mhealth = "mise run health"

# Platform shortcuts
pdev = "mise run platform:dev"
pbuild = "mise run platform:build"
ptest = "mise run platform:test"

# Engine shortcuts
edev = "mise run engine:dev"
ebuild = "mise run engine:build"
etest = "mise run engine:test"

# Git shortcuts (via gita)
gstatus = "mise run git:status"
gfetch = "mise run git:fetch"
gpull = "mise run git:pull"

# Drift shortcuts
dscan = "mise run drift:scan"
dstatus = "mise run drift:status"
dcheck = "mise run drift:check"
dgate = "mise run drift:gate"
dwatch = "mise run drift:watch"
dbound = "mise run drift:boundaries"
dtrend = "mise run drift:trends"

# Changelog shortcuts
clog = "mise run changelog:preview"
cgen = "mise run changelog:generate"
cbump = "mise run changelog:bump"

