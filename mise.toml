#:schema ./schema/mise.json
# Metorial Workspace Configuration
# https://mise.jdx.dev/configuration.html

min_version = "2026.1.0"

# ============================================================================
# MONOREPO ROOT CONFIGURATION
# ============================================================================
# Enable unified task discovery across all sub-projects
# Requires MISE_EXPERIMENTAL=1 (set in [env] below)
experimental_monorepo_root = true

[monorepo]
# Define all config roots for task namespacing
# Tasks from these directories are discoverable via `mise tasks --all`
config_roots = [
    "metorial",
    "metorial-docs",
    "metorial-index",
    "metorial-platform",
    "metorial-platform/src/mcp-engine",
]

[settings]
experimental = true  # Enable MCP server for AI assistants

# ============================================================================
# HOOKS - Automatic Environment Setup
# ============================================================================
[hooks]
# Auto-install tools when entering workspace directory
# This ensures all developers have correct tool versions automatically
enter = "mise install -q"

# ============================================================================
# PREPARE - Auto-Dependency Management
# ============================================================================
# Automatically install dependencies when lockfiles change
# Runs before `mise run` or `mise x` when auto = true
# Run `mise prep` manually to install all dependencies

[prepare.bun-platform]
auto = true
dir = "metorial-platform"
sources = ["metorial-platform/bun.lock", "metorial-platform/package.json"]
outputs = ["metorial-platform/node_modules/"]
run = "bun install"
description = "Install platform dependencies when lockfile changes"

[prepare.bun-catalog]
auto = true
dir = "metorial"
sources = ["metorial/bun.lock", "metorial/package.json"]
outputs = ["metorial/node_modules/"]
run = "bun install"
description = "Install catalog dependencies when lockfile changes"

[prepare.bun-index]
auto = true
dir = "metorial-index"
sources = ["metorial-index/bun.lock", "metorial-index/package.json"]
outputs = ["metorial-index/node_modules/"]
run = "bun install"
description = "Install index dependencies when lockfile changes"

[env]
# Workspace identification
METORIAL_WORKSPACE = "true"
# Enable mise experimental features (required for monorepo support)
MISE_EXPERIMENTAL = "1"

[tools]
# Node.js 24 LTS "Krypton" - platform frontend and services (EOL: April 2028)
node = "24"
# Bun 1.3.x - platform runtime and package management (acquired by Anthropic Dec 2025)
bun = "1.3"
# Go 1.24 - mcp-engine (latest stable as of Jan 2026)
go = "1.24"
# Yarn - metorial catalog package manager
yarn = "1"
# Multi-repo git operations (via pipx backend)
# Provides async batch git operations, visual status, and group management
"pipx:gita" = "latest"
# Markdown linting
"npm:markdownlint-cli" = "latest"

# ============================================================================
# TASK CONFIGURATION
# ============================================================================
[task_config]
# Additional task directories
includes = [".mise/tasks"]

# ============================================================================
# PLATFORM TASKS (metorial-platform)
# ============================================================================
[tasks."platform:install"]
description = "Install platform dependencies"
dir = "metorial-platform"
run = "bun install"

[tasks."platform:build"]
description = "Build all platform packages"
dir = "metorial-platform"
run = "bun run build"
depends = ["platform:install"]

[tasks."platform:dev"]
description = "Start platform development servers"
dir = "metorial-platform"
run = "bun run dev"

[tasks."platform:test"]
description = "Run platform tests"
dir = "metorial-platform"
run = "bun run test"

[tasks."platform:prisma:generate"]
description = "Generate Prisma client"
dir = "metorial-platform"
run = "bun run prisma:generate"

[tasks."platform:prisma:push"]
description = "Push Prisma schema to database"
dir = "metorial-platform"
run = "bun run prisma:push"

[tasks."platform:client:generate"]
description = "Generate API clients"
dir = "metorial-platform"
run = "bun run client:generate"

# ============================================================================
# MCP ENGINE TASKS (Go - wrapping Makefile)
# ============================================================================
[tasks."engine:build"]
description = "Build unified MCP engine binary"
dir = "metorial-platform/src/mcp-engine"
run = "make build-unified"

[tasks."engine:dev"]
description = "Start MCP engine with hot reload (air)"
dir = "metorial-platform/src/mcp-engine"
run = "make dev"

[tasks."engine:test"]
description = "Run MCP engine tests"
dir = "metorial-platform/src/mcp-engine"
run = "make test"

[tasks."engine:lint"]
description = "Run Go linters on MCP engine"
dir = "metorial-platform/src/mcp-engine"
run = "make lint"

[tasks."engine:vet"]
description = "Run go vet on MCP engine"
dir = "metorial-platform/src/mcp-engine"
run = "make vet"

[tasks."engine:proto"]
description = "Generate protobuf files"
dir = "metorial-platform/src/mcp-engine"
run = "make proto"

# ============================================================================
# CATALOG TASKS (metorial)
# ============================================================================
[tasks."catalog:add-server"]
description = "Add a new MCP server to the catalog"
dir = "metorial"
run = "bun run add-server"

[tasks."catalog:build"]
description = "Build all MCP servers"
dir = "metorial"
run = "bun run build"

[tasks."catalog:check-versions"]
description = "Check version consistency across servers"
dir = "metorial"
run = "bun run check-versions"

# ============================================================================
# DOCS TASKS (metorial-docs)
# ============================================================================
[tasks."docs:dev"]
description = "Start Mintlify documentation server"
dir = "metorial-docs"
run = "mint dev"

[tasks."docs:build"]
description = "Build documentation site"
dir = "metorial-docs"
run = "mint build"

# ============================================================================
# INDEX TASKS (metorial-index)
# ============================================================================
[tasks."index:build"]
description = "Build server index"
dir = "metorial-index"
run = "bun run build"

# ============================================================================
# WORKSPACE-LEVEL TASKS
# ============================================================================
[tasks.install]
description = "Install all workspace dependencies"
depends = ["platform:install"]
run = "echo 'All dependencies installed'"

[tasks.build]
description = "Build entire workspace"
depends = ["platform:build", "catalog:build", "engine:build"]
run = "echo 'Full workspace build complete'"

[tasks.dev]
description = "Start all development servers"
depends = ["platform:dev"]
run = "echo 'Development servers started'"

[tasks.test]
description = "Run all tests"
depends = ["platform:test", "engine:test"]
run = "echo 'All tests complete'"

[tasks.lint]
description = "Run all linters"
depends = ["engine:lint"]
run = "echo 'Linting complete'"

# ============================================================================
# MULTI-REPO GIT OPERATIONS (via gita)
# ============================================================================
# These tasks wrap gita commands for team standardization and discoverability
# gita is installed via mise's pipx backend (see [tools] section)

[tasks."git:status"]
description = "Show visual status of all repositories (via gita)"
run = "gita ll"
alias = "gs"

[tasks."git:fetch"]
description = "Fetch all repositories asynchronously (via gita)"
run = "gita fetch"
alias = "gf"

[tasks."git:pull"]
description = "Pull all repositories (via gita)"
run = "gita pull"
alias = "gp"
confirm = "This will pull changes in all repositories. Continue?"

[tasks."git:push"]
description = "Push all repositories (via gita)"
run = "gita push"
confirm = "This will push changes in all repositories. Continue?"

[tasks."git:branches"]
description = "Show branches across all repositories"
run = "gita branch"

[tasks."git:checkout"]
description = "Checkout branch in all repositories"
run = "gita super checkout $1"
usage = 'arg "<branch>" help="Branch name to checkout"'

[tasks."git:stash"]
description = "Stash changes in all repositories"
run = "gita super stash"

[tasks."git:stash-pop"]
description = "Pop stashed changes in all repositories"
run = "gita super stash pop"

# ============================================================================
# SHELL ALIASES
# ============================================================================
# Quick shortcuts when mise shell integration is active
# Usage: Type alias directly in shell (e.g., `mdev` instead of `mise run dev`)

[shell_alias]
# Workspace shortcuts
mdev = "mise run dev"
mbuild = "mise run build"
mtest = "mise run test"
mstatus = "mise run status"
mhealth = "mise run health"

# Platform shortcuts
pdev = "mise run platform:dev"
pbuild = "mise run platform:build"
ptest = "mise run platform:test"

# Engine shortcuts
edev = "mise run engine:dev"
ebuild = "mise run engine:build"
etest = "mise run engine:test"

# Git shortcuts (via gita)
gstatus = "mise run git:status"
gfetch = "mise run git:fetch"
gpull = "mise run git:pull"

