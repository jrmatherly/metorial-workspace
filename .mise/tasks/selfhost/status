#!/usr/bin/env bash
#MISE description="Show status of self-hosted services"
set -euo pipefail

COMPOSE_FILE="metorial-platform/self-hosting/docker-compose.yml"

echo "━━━ Self-Hosted Services Status ━━━"
echo ""

if [ ! -f "$COMPOSE_FILE" ]; then
    echo "✗ docker-compose.yml not found at: $COMPOSE_FILE"
    exit 1
fi

echo "[Docker Compose Services]"
docker compose -f "$COMPOSE_FILE" ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}" 2>/dev/null || \
    docker compose -f "$COMPOSE_FILE" ps

echo ""
echo "[Local Images]"
docker images --format "table {{.Repository}}:{{.Tag}}\t{{.Size}}\t{{.CreatedSince}}" | \
    grep -E "^metorial-|^REPOSITORY" | head -10 || echo "  No local metorial images found"

echo ""
echo "[Health Checks]"
# Check API health - accept any HTTP response (including 401) as "responding"
API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:4310/ 2>/dev/null || echo "000")
if [ "$API_STATUS" = "000" ]; then
    echo "  API:        ✗ not responding"
elif [ "$API_STATUS" = "200" ] || [ "$API_STATUS" = "204" ]; then
    echo "  API:        ✓ healthy (HTTP $API_STATUS)"
else
    echo "  API:        ✓ responding (HTTP $API_STATUS)"
fi

# Check PostgreSQL
if docker compose -f "$COMPOSE_FILE" exec -T postgres-db pg_isready -U postgres &>/dev/null; then
    echo "  PostgreSQL: ✓ ready"
else
    echo "  PostgreSQL: ✗ not ready"
fi

# Check Redis
if docker compose -f "$COMPOSE_FILE" exec -T redis-db redis-cli ping &>/dev/null; then
    echo "  Redis:      ✓ ready"
else
    echo "  Redis:      ✗ not ready"
fi
