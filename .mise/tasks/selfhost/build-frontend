#!/usr/bin/env bash
#MISE description="Build Dashboard frontend Docker image locally"
#MISE depends=["platform:prisma:generate"]
set -euo pipefail

echo "━━━ Building Frontend Docker Image ━━━"
echo ""

cd metorial-platform

# Use pre-build approach: build frontend on host, then create minimal Docker image
# This avoids OrbStack/Docker buildkit issues with turbo builds

DOCKERFILE="deployment/dockerfiles/frontend-prebuilt.Dockerfile"
IMAGE_NAME="metorial-frontend:local"
DIST_DIR="src/frontend/apps/dashboard/dist"

echo "→ Step 1: Building frontend on host..."
echo ""

# Build frontend using turbo (on host, not in Docker)
bun turbo run frontend:build --filter=@metorial/app-dashboard --concurrency=1

# Verify build output exists
if [ ! -d "$DIST_DIR" ]; then
    echo "✗ Frontend build failed - dist folder not found at: $DIST_DIR"
    exit 1
fi

echo ""
echo "✓ Frontend build complete"
echo ""

echo "→ Step 2: Creating Docker image..."
echo ""

if [ ! -f "$DOCKERFILE" ]; then
    echo "✗ Dockerfile not found at: $DOCKERFILE"
    exit 1
fi

docker build \
    -f "$DOCKERFILE" \
    -t "$IMAGE_NAME" \
    .

echo ""
echo "✓ Frontend image built: $IMAGE_NAME"
echo ""
echo "To run: docker run -p 3300:3300 $IMAGE_NAME"
