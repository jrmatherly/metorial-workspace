# Metorial Workspace CI Pipeline
# Validates workspace configuration and runs tests across all projects
#
# Optimized for January 2026:
# - actions/checkout@v5 (Node 24, Aug 2025)
# - jdx/mise-action@v3 (v3.6.1, improved caching)
# - actions/cache@v5 (new cache service v2)
# - Shared setup job to avoid redundant repository cloning

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  MISE_EXPERIMENTAL: "1"
  # Pin mise version to avoid "vlatest" URL bug in mise-action
  MISE_VERSION: "2026.1.11"

jobs:
  # =============================================================================
  # SETUP - Clone repositories once and cache for all jobs
  # =============================================================================
  setup:
    name: Setup Workspace
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}

    steps:
      - name: Checkout workspace
        uses: actions/checkout@v5

      - name: Generate cache key
        id: cache-key
        run: echo "key=repos-${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Cache project repositories
        id: cache-repos
        uses: actions/cache@v5
        with:
          path: |
            metorial
            metorial-docs
            metorial-index
            metorial-platform
          key: ${{ steps.cache-key.outputs.key }}

      - name: Clone project repositories
        if: steps.cache-repos.outputs.cache-hit != 'true'
        run: |
          git clone --depth 1 https://github.com/jrmatherly/metorial.git metorial
          git clone --depth 1 https://github.com/jrmatherly/metorial-docs.git metorial-docs
          git clone --depth 1 https://github.com/jrmatherly/metorial-index.git metorial-index
          git clone --depth 1 https://github.com/jrmatherly/metorial-platform.git metorial-platform

      - name: Setup mise
        uses: jdx/mise-action@v3
        with:
          version: ${{ env.MISE_VERSION }}
          install: true
          cache: true
          cache_key_prefix: "mise-v1"
          experimental: true
          log_level: info
          github_token: ${{ secrets.GITHUB_TOKEN }}

  # =============================================================================
  # VALIDATE - Check workspace configuration and standards
  # =============================================================================
  validate:
    name: Validate Workspace
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - name: Checkout workspace
        uses: actions/checkout@v5

      - name: Restore cached repositories
        uses: actions/cache@v5
        with:
          path: |
            metorial
            metorial-docs
            metorial-index
            metorial-platform
          key: ${{ needs.setup.outputs.cache-key }}
          fail-on-cache-miss: true

      - name: Setup mise
        uses: jdx/mise-action@v3
        with:
          version: ${{ env.MISE_VERSION }}
          install: true
          cache: true
          cache_key_prefix: "mise-v1"
          experimental: true
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run workspace validation
        run: mise run validate

  # =============================================================================
  # BUILD - Build all workspace packages
  # =============================================================================
  build:
    name: Build Workspace
    runs-on: ubuntu-latest
    needs: [setup, validate]

    steps:
      - name: Checkout workspace
        uses: actions/checkout@v5

      - name: Restore cached repositories
        uses: actions/cache@v5
        with:
          path: |
            metorial
            metorial-docs
            metorial-index
            metorial-platform
          key: ${{ needs.setup.outputs.cache-key }}
          fail-on-cache-miss: true

      - name: Setup mise
        uses: jdx/mise-action@v3
        with:
          version: ${{ env.MISE_VERSION }}
          install: true
          cache: true
          cache_key_prefix: "mise-v1"
          experimental: true
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install dependencies
        run: mise run install

      - name: Build workspace
        run: mise run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-outputs
          path: |
            metorial-platform/dist
            metorial-platform/node_modules/.package-lock.json
          retention-days: 1
          if-no-files-found: ignore

  # =============================================================================
  # TEST - Run all tests (uses build artifacts)
  # =============================================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: [setup, build]

    steps:
      - name: Checkout workspace
        uses: actions/checkout@v5

      - name: Restore cached repositories
        uses: actions/cache@v5
        with:
          path: |
            metorial
            metorial-docs
            metorial-index
            metorial-platform
          key: ${{ needs.setup.outputs.cache-key }}
          fail-on-cache-miss: true

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-outputs
          path: metorial-platform
        continue-on-error: true

      - name: Setup mise
        uses: jdx/mise-action@v3
        with:
          version: ${{ env.MISE_VERSION }}
          install: true
          cache: true
          cache_key_prefix: "mise-v1"
          experimental: true
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install dependencies
        run: mise run install

      - name: Run tests
        run: mise run test

  # =============================================================================
  # LINT - Run linters (can run in parallel with build)
  # =============================================================================
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    needs: [setup, validate]

    steps:
      - name: Checkout workspace
        uses: actions/checkout@v5

      - name: Restore cached repositories
        uses: actions/cache@v5
        with:
          path: |
            metorial
            metorial-docs
            metorial-index
            metorial-platform
          key: ${{ needs.setup.outputs.cache-key }}
          fail-on-cache-miss: true

      - name: Setup mise
        uses: jdx/mise-action@v3
        with:
          version: ${{ env.MISE_VERSION }}
          install: true
          cache: true
          cache_key_prefix: "mise-v1"
          experimental: true
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install dependencies
        run: mise run install

      - name: Run linters
        run: mise run lint

  # =============================================================================
  # DRIFT - Pattern compliance quality gate (uses committed baselines)
  # =============================================================================
  # Architecture:
  # - Baselines (.drift/patterns/approved/, indexes/, views/) are committed to each repo
  # - CI validates against these committed baselines - NO scanning required
  # - Full scans only run via weekly scheduled workflow
  #
  # Why no drift:scan here:
  # - Scanning discovers patterns (expensive, 30+ min for large codebases)
  # - Quality gate validates against existing approved patterns (fast, seconds)
  # - Baselines should be updated locally and committed, not regenerated in CI
  # =============================================================================
  drift-check:
    name: Drift Quality Gate
    runs-on: ubuntu-latest
    needs: [setup, validate]
    timeout-minutes: 5
    permissions:
      security-events: write
      contents: read

    steps:
      - name: Checkout workspace
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Restore cached repositories
        uses: actions/cache@v5
        with:
          path: |
            metorial
            metorial-docs
            metorial-index
            metorial-platform
          key: ${{ needs.setup.outputs.cache-key }}
          fail-on-cache-miss: true

      # Note: No separate Drift cache needed - baselines are committed to each repo
      # The cloned repos already include .drift/config.json, patterns/approved/, indexes/, views/

      - name: Setup mise
        uses: jdx/mise-action@v3
        with:
          version: ${{ env.MISE_VERSION }}
          install: true
          cache: true
          cache_key_prefix: "mise-v1"
          experimental: true
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify Drift baselines exist
        run: |
          echo "Verifying Drift baselines are present..."
          for repo in metorial metorial-platform metorial-index; do
            if [ -f "$repo/.drift/config.json" ]; then
              echo "âœ“ $repo/.drift/config.json exists"
            else
              echo "âœ— $repo/.drift/config.json MISSING"
              exit 1
            fi
          done

      - name: Run Drift quality gate
        run: |
          echo "Running quality gate against committed baselines..."
          mise run drift:gate

      - name: Generate SARIF report
        if: always()
        run: |
          # Generate SARIF for Platform (main project)
          (cd metorial-platform && drift gate --ci --format sarif -o ../drift-results.sarif) 2>/dev/null || true

      - name: Upload SARIF to GitHub Code Scanning
        if: always() && hashFiles('drift-results.sarif') != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: drift-results.sarif
          category: drift-patterns

      - name: Check security boundaries
        run: |
          echo "Checking security boundaries..."
          mise run drift:boundaries-check

  # =============================================================================
  # DRIFT TRENDS - Weekly pattern health analysis (on main pushes)
  # =============================================================================
  drift-trends:
    name: Drift Trends Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [setup]

    steps:
      - name: Checkout workspace
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Restore cached repositories
        uses: actions/cache@v5
        with:
          path: |
            metorial
            metorial-docs
            metorial-index
            metorial-platform
          key: ${{ needs.setup.outputs.cache-key }}
          fail-on-cache-miss: true

      - name: Restore Drift cache
        uses: actions/cache@v5
        with:
          path: |
            metorial/.drift
            metorial-platform/.drift
            metorial-index/.drift
          key: drift-${{ runner.os }}-${{ hashFiles('metorial/**/*.ts', 'metorial-platform/**/*.ts', 'metorial-index/**/*.ts') }}
          restore-keys: |
            drift-${{ runner.os }}-

      - name: Setup mise
        uses: jdx/mise-action@v3
        with:
          version: ${{ env.MISE_VERSION }}
          install: true
          cache: true
          cache_key_prefix: "mise-v1"
          experimental: true
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run trend analysis
        run: |
          echo "=== 7-Day Trends ==="
          mise run drift:trends
          echo ""
          echo "=== 30-Day Trends ==="
          mise run drift:trends-30d

  # =============================================================================
  # CHANGELOG - Preview changes in pull requests
  # =============================================================================
  changelog-preview:
    name: Changelog Preview
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: [setup]

    steps:
      - name: Checkout workspace
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Restore cached repositories
        uses: actions/cache@v5
        with:
          path: |
            metorial
            metorial-docs
            metorial-index
            metorial-platform
          key: ${{ needs.setup.outputs.cache-key }}
          fail-on-cache-miss: true

      - name: Setup mise
        uses: jdx/mise-action@v3
        with:
          version: ${{ env.MISE_VERSION }}
          install: true
          cache: true
          cache_key_prefix: "mise-v1"
          experimental: true
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate changelog preview
        run: |
          echo "## ðŸ“‹ Changelog Preview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Changes that would be added to the changelog from this PR:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```markdown' >> $GITHUB_STEP_SUMMARY
          mise run changelog:preview >> $GITHUB_STEP_SUMMARY 2>&1 || echo "No conventional commits found in this PR"
          echo '```' >> $GITHUB_STEP_SUMMARY
