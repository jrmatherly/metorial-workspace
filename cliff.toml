# Metorial Workspace Changelog Configuration
# https://git-cliff.org/docs/configuration/
#
# Generates changelogs from git history using Conventional Commits.
# Integrates with mise tasks (mise run changelog:*) for automation.

[changelog]
# Header template rendered once at the beginning
header = """
# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.1.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

"""

# Body template rendered for each release
body = """
{% if version %}\
    ## [{{ version | trim_start_matches(pat="v") }}] - {{ timestamp | date(format="%Y-%m-%d") }}
{% else %}\
    ## [Unreleased]
{% endif %}\
{% for group, commits in commits | group_by(attribute="group") %}
    ### {{ group | striptags | trim | upper_first }}
    {% for commit in commits %}
        - {% if commit.scope %}*({{ commit.scope }})* {% endif %}\
            {% if commit.breaking %}[**BREAKING**] {% endif %}\
            {{ commit.message | upper_first }}\
            {% if commit.remote.pr_number %} ([#{{ commit.remote.pr_number }}](https://github.com/{{ remote.github.owner }}/{{ remote.github.repo }}/pull/{{ commit.remote.pr_number }})){% endif %}\
            {% if commit.remote.username %} by @{{ commit.remote.username }}{% endif %}
    {% endfor %}
{% endfor %}
"""

# Footer template rendered once at the end
footer = """
<!-- Generated by git-cliff - https://git-cliff.org -->
"""

# Remove leading/trailing whitespace from body
trim = true

# Only render body when there are releases to process
render_always = false

# Post-process the changelog output
postprocessors = [
    # Replace repository placeholder with actual URL
    { pattern = '\$REPO', replace = "https://github.com/jrmatherly" },
]

[git]
# Parse commits according to Conventional Commits specification
# https://www.conventionalcommits.org/
conventional_commits = true

# Filter out non-conventional commits from changelog
filter_unconventional = true

# Don't require all commits to be conventional (allow mixed history)
require_conventional = false

# Process entire commit message, not line by line
split_commits = false

# Protect breaking changes from being filtered
protect_breaking_commits = true

# Commit categorization with emojis
# Order matters - first match wins
commit_parsers = [
    { message = "^feat", group = "ğŸš€ Features" },
    { message = "^fix", group = "ğŸ› Bug Fixes" },
    { message = "^doc", group = "ğŸ“š Documentation" },
    { message = "^perf", group = "âš¡ Performance" },
    { message = "^refactor", group = "ğŸ”„ Refactor" },
    { message = "^style", group = "ğŸ¨ Styling" },
    { message = "^test", group = "ğŸ§ª Testing" },
    { message = "^build", group = "ğŸ“¦ Build" },
    { message = "^ci", group = "ğŸ‘· CI/CD" },
    # Skip release preparation commits
    { message = "^chore\\(release\\)", skip = true },
    # Skip dependency updates (usually automated)
    { message = "^chore\\(deps\\)", skip = true },
    # Skip PR-related chores
    { message = "^chore\\(pr\\)", skip = true },
    { message = "^chore\\(pull\\)", skip = true },
    # General chores go to miscellaneous
    { message = "^chore", group = "âš™ï¸ Miscellaneous" },
    # Reverts
    { message = "^revert", group = "â—€ï¸ Revert" },
    # Security-related changes (matched by body)
    { body = ".*security", group = "ğŸ›¡ï¸ Security" },
]

# Don't filter out unmatched commits (include them)
filter_commits = false

# Don't fail if a commit doesn't match any parser
fail_on_unmatched_commit = false

# Tag pattern for semantic versioning
tag_pattern = "v[0-9].*"

# Bump version settings
[bump]
# Add 'v' prefix to bumped versions to match tag_pattern
initial_tag = "v0.1.0"

# Sort commits oldest first within each release
sort_commits = "oldest"

# Link parsers for extracting references
link_parsers = [
    # GitHub issues: #123
    { pattern = "#(\\d+)", href = "https://github.com/jrmatherly/metorial-platform/issues/$1" },
]

[remote.github]
# GitHub repository information for PR/contributor links
# Override repo per-project using --github-repo flag or environment variable
owner = "jrmatherly"
repo = "metorial-platform"
