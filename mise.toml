#:schema ./schema/mise.json
# Metorial Workspace Configuration
# https://mise.jdx.dev/configuration.html

min_version = "2026.1.0"

# ============================================================================
# WORKSPACE CONFIGURATION
# ============================================================================
# This is a polyrepo workspace - all mise tasks are centrally defined here.
# Sub-repos (metorial, metorial-platform, etc.) don't have their own mise configs.

[settings]
experimental = true  # Enable MCP server for AI assistants

# ============================================================================
# HOOKS - Automatic Environment Setup
# ============================================================================
[hooks]
# Auto-install tools when entering workspace directory
# This ensures all developers have correct tool versions automatically
enter = "mise install -q"

# ============================================================================
# PREPARE - Auto-Dependency Management
# ============================================================================
# Automatically install dependencies when lockfiles change
# Runs before `mise run` or `mise x` when auto = true
# Run `mise prep` manually to install all dependencies

[prepare.bun-platform]
auto = true
dir = "metorial-platform"
sources = ["metorial-platform/bun.lock"]
outputs = ["metorial-platform/node_modules/"]
run = "bun install"
description = "Install platform dependencies when lockfile changes"

[prepare.bun-catalog]
auto = true
dir = "metorial"
sources = ["metorial/bun.lock"]
outputs = ["metorial/node_modules/"]
run = "bun install"
description = "Install catalog dependencies when lockfile changes"

[prepare.bun-index]
auto = true
dir = "metorial-index"
sources = ["metorial-index/bun.lock"]
outputs = ["metorial-index/node_modules/"]
run = "bun install"
description = "Install index dependencies when lockfile changes"

[env]
# Workspace identification
METORIAL_WORKSPACE = "true"
# Enable mise experimental features (required for monorepo support)
MISE_EXPERIMENTAL = "1"

[tools]
# Node.js 24 LTS "Krypton" - platform frontend and services (EOL: April 2028)
node = "24"
# Bun 1.3.x - platform runtime and package management (acquired by Anthropic Dec 2025)
bun = "1.3"
# Go 1.24 - mcp-engine (latest stable as of Jan 2026)
go = "1.24"
# Yarn - metorial catalog package manager
yarn = "1"
# Multi-repo git operations (via pipx backend)
# Provides async batch git operations, visual status, and group management
"pipx:gita" = "latest"
# Markdown linting
"npm:markdownlint-cli" = "latest"
# Drift - Codebase intelligence for AI agents
# Provides pattern detection, call graph analysis, and AI context curation
"npm:driftdetect" = "latest"
"npm:driftdetect-mcp" = "latest"
# Go linting tool for mcp-engine
golangci-lint = "latest"
# Changelog generation from git history (Conventional Commits)
# https://git-cliff.org/docs/
"aqua:orhun/git-cliff" = "latest"

# ============================================================================
# TASK CONFIGURATION
# ============================================================================
[task_config]
# Additional task directories
includes = [".mise/tasks"]

# ============================================================================
# PLATFORM TASKS (metorial-platform)
# ============================================================================
[tasks."platform:install"]
description = "Install platform dependencies"
dir = "metorial-platform"
run = "bun install"

[tasks."platform:build"]
description = "Build all platform packages"
dir = "metorial-platform"
run = "bun run build"
depends = ["platform:install"]

[tasks."platform:dev"]
description = "Start platform development servers"
dir = "metorial-platform"
run = "bun run dev"

[tasks."platform:test"]
description = "Run platform tests"
dir = "metorial-platform"
run = "bun run test"

[tasks."platform:prisma:generate"]
description = "Generate Prisma client"
dir = "metorial-platform"
run = "bun run prisma:generate"

[tasks."platform:prisma:push"]
description = "Push Prisma schema to database"
dir = "metorial-platform"
run = "bun run prisma:push"

[tasks."platform:client:generate"]
description = "Generate API clients"
dir = "metorial-platform"
run = "bun run client:generate"

# ============================================================================
# MCP ENGINE TASKS (Go - wrapping Makefile)
# ============================================================================
[tasks."engine:build"]
description = "Build unified MCP engine binary"
dir = "metorial-platform/src/mcp-engine"
run = "make build-unified"

[tasks."engine:dev"]
description = "Start MCP engine with hot reload (air)"
dir = "metorial-platform/src/mcp-engine"
run = "make dev"

[tasks."engine:test"]
description = "Run MCP engine tests"
dir = "metorial-platform/src/mcp-engine"
run = "make test"

[tasks."engine:lint"]
description = "Run Go linters on MCP engine"
dir = "metorial-platform/src/mcp-engine"
run = "make lint"

[tasks."engine:vet"]
description = "Run go vet on MCP engine"
dir = "metorial-platform/src/mcp-engine"
run = "make vet"

[tasks."engine:proto"]
description = "Generate protobuf files"
dir = "metorial-platform/src/mcp-engine"
run = "make proto"

# ============================================================================
# CATALOG TASKS (metorial)
# ============================================================================
[tasks."catalog:add-server"]
description = "Add a new MCP server to the catalog"
dir = "metorial"
run = "bun run add-server"

[tasks."catalog:build"]
description = "Build a specific MCP server (requires serverId)"
dir = "metorial"
run = "bun run build single $1"
usage = 'arg "<serverId>" help="Server ID to build (e.g., github)"'

[tasks."catalog:build-all"]
description = "Build all MCP servers (requires Docker)"
dir = "metorial"
run = "bun run build all"

[tasks."catalog:check-versions"]
description = "Check version consistency across servers"
dir = "metorial"
run = "bun run check-versions"

# ============================================================================
# DOCS TASKS (metorial-docs)
# ============================================================================
[tasks."docs:dev"]
description = "Start Mintlify documentation server"
dir = "metorial-docs"
run = "mint dev"

[tasks."docs:build"]
description = "Build documentation site"
dir = "metorial-docs"
run = "mint build"

# ============================================================================
# INDEX TASKS (metorial-index)
# ============================================================================
[tasks."index:build"]
description = "Build server index"
dir = "metorial-index"
run = "bun run build"

# ============================================================================
# WORKSPACE-LEVEL TASKS
# ============================================================================
[tasks.install]
description = "Install all workspace dependencies"
depends = ["platform:install"]
run = "echo 'All dependencies installed'"

[tasks.build]
description = "Build entire workspace (excludes catalog Docker builds)"
depends = ["platform:build", "engine:build"]
run = "echo 'Full workspace build complete'"

[tasks."build:full"]
description = "Build entire workspace including catalog (requires Docker)"
depends = ["platform:build", "catalog:build-all", "engine:build"]
run = "echo 'Full workspace build with catalog complete'"

[tasks.dev]
description = "Start all development servers"
depends = ["platform:dev"]
run = "echo 'Development servers started'"

[tasks.test]
description = "Run all tests"
depends = ["platform:test", "engine:test"]
run = "echo 'All tests complete'"

[tasks.lint]
description = "Run all linters"
depends = ["engine:lint"]
run = "echo 'Linting complete'"

# ============================================================================
# DRIFT TASKS - Codebase Intelligence for AI
# ============================================================================
# Drift scans your code, learns your patterns, and provides context to AI agents
# Documentation: https://github.com/dadbodgeoff/drift/wiki

[tasks."drift:init"]
description = "Initialize Drift in a repository"
run = "drift init --yes"

[tasks."drift:scan"]
description = "Scan all projects for patterns (incremental)"
run = '''
drift scan -p 'MCP Catalog' --incremental
drift scan -p 'Platform' --incremental
drift scan -p 'Index Registry' --incremental
echo '✓ All projects scanned'
'''

[tasks."drift:scan-full"]
description = "Full pattern scan all projects (ignores cache)"
run = '''
drift scan -p 'MCP Catalog' --force
drift scan -p 'Platform' --force
drift scan -p 'Index Registry' --force
echo '✓ Full scan complete for all projects'
'''

[tasks."drift:status"]
description = "Show pattern status for all projects"
run = '''
echo "━━━ Pattern Status ━━━"
echo ""
echo "→ MCP Catalog"
(cd metorial && drift status --detailed) || true
echo ""
echo "→ Platform"
(cd metorial-platform && drift status --detailed) || true
echo ""
echo "→ Index Registry"
(cd metorial-index && drift status --detailed) || true
'''

[tasks."drift:check"]
description = "Check staged changes for pattern compliance"
run = '''
echo "━━━ Checking Staged Changes ━━━"
echo ""
echo "→ MCP Catalog"
(cd metorial && drift check --staged) || true
echo ""
echo "→ Platform"
(cd metorial-platform && drift check --staged) || true
echo ""
echo "→ Index Registry"
(cd metorial-index && drift check --staged) || true
'''

[tasks."drift:gate"]
description = "Run quality gate (CI mode) on all projects"
run = '''
echo "━━━ Quality Gate (CI) ━━━"
FAILED=0
echo ""
echo "→ MCP Catalog"
(cd metorial && drift gate --ci --format github) || FAILED=1
echo ""
echo "→ Platform"
(cd metorial-platform && drift gate --ci --format github) || FAILED=1
echo ""
echo "→ Index Registry"
(cd metorial-index && drift gate --ci --format github) || FAILED=1
exit $FAILED
'''

[tasks."drift:gate-strict"]
description = "Run strict quality gate on all projects"
run = '''
echo "━━━ Quality Gate (Strict) ━━━"
FAILED=0
echo ""
echo "→ MCP Catalog"
(cd metorial && drift gate --policy strict --format github) || FAILED=1
echo ""
echo "→ Platform"
(cd metorial-platform && drift gate --policy strict --format github) || FAILED=1
echo ""
echo "→ Index Registry"
(cd metorial-index && drift gate --policy strict --format github) || FAILED=1
exit $FAILED
'''

[tasks."drift:approve"]
description = "Approve high-confidence patterns interactively"
run = '''
echo "━━━ Approve Patterns (Interactive) ━━━"
echo ""
echo "→ MCP Catalog"
(cd metorial && drift approve --min-confidence 0.9)
echo ""
echo "→ Platform"
(cd metorial-platform && drift approve --min-confidence 0.9)
echo ""
echo "→ Index Registry"
(cd metorial-index && drift approve --min-confidence 0.9)
'''

[tasks."drift:callgraph"]
description = "Build call graph for all projects"
run = '''
echo "━━━ Building Call Graphs ━━━"
echo ""
echo "→ MCP Catalog"
(cd metorial && drift callgraph build)
echo ""
echo "→ Platform"
(cd metorial-platform && drift callgraph build)
echo ""
echo "→ Index Registry"
(cd metorial-index && drift callgraph build)
echo ""
echo "✓ All call graphs built"
'''

[tasks."drift:callgraph-status"]
description = "Show call graph status for all projects"
run = '''
echo "━━━ Call Graph Status ━━━"
echo ""
echo "→ MCP Catalog"
(cd metorial && drift callgraph status)
echo ""
echo "→ Platform"
(cd metorial-platform && drift callgraph status)
echo ""
echo "→ Index Registry"
(cd metorial-index && drift callgraph status)
'''

[tasks."drift:test-topology"]
description = "Build test-to-code mapping for all projects"
run = '''
echo "━━━ Building Test Topology ━━━"
echo ""
echo "→ MCP Catalog"
(cd metorial && drift test-topology build)
echo ""
echo "→ Platform"
(cd metorial-platform && drift test-topology build)
echo ""
echo "→ Index Registry"
(cd metorial-index && drift test-topology build)
echo ""
echo "✓ All test topologies built"
'''

[tasks."drift:coupling"]
description = "Build module coupling analysis for all projects"
run = '''
echo "━━━ Building Module Coupling Analysis ━━━"
echo ""
echo "→ MCP Catalog"
(cd metorial && drift coupling build)
echo ""
echo "→ Platform"
(cd metorial-platform && drift coupling build)
echo ""
echo "→ Index Registry"
(cd metorial-index && drift coupling build)
echo ""
echo "✓ All coupling analysis built"
'''

[tasks."drift:coupling-cycles"]
description = "Find dependency cycles in all projects"
run = '''
echo "━━━ Finding Dependency Cycles ━━━"
echo ""
echo "→ MCP Catalog"
(cd metorial && drift coupling cycles)
echo ""
echo "→ Platform"
(cd metorial-platform && drift coupling cycles)
echo ""
echo "→ Index Registry"
(cd metorial-index && drift coupling cycles)
'''

[tasks."drift:error-handling"]
description = "Build error handling analysis for all projects"
run = '''
echo "━━━ Building Error Handling Analysis ━━━"
echo ""
echo "→ MCP Catalog"
(cd metorial && drift error-handling build)
echo ""
echo "→ Platform"
(cd metorial-platform && drift error-handling build)
echo ""
echo "→ Index Registry"
(cd metorial-index && drift error-handling build)
echo ""
echo "✓ All error handling analysis built"
'''

[tasks."drift:context"]
description = "Generate AI context for all projects"
run = '''
echo "━━━ AI Context Generation ━━━"
echo ""
echo "→ MCP Catalog"
(cd metorial && drift context --format ai --snippets) || true
echo ""
echo "→ Platform"
(cd metorial-platform && drift context --format ai --snippets) || true
echo ""
echo "→ Index Registry"
(cd metorial-index && drift context --format ai --snippets) || true
'''

[tasks."drift:troubleshoot"]
description = "Diagnose Drift issues in all projects"
run = '''
echo "━━━ Drift Troubleshooting ━━━"
echo ""
echo "→ MCP Catalog"
(cd metorial && drift troubleshoot) || true
echo ""
echo "→ Platform"
(cd metorial-platform && drift troubleshoot) || true
echo ""
echo "→ Index Registry"
(cd metorial-index && drift troubleshoot) || true
'''

[tasks."drift:next-steps"]
description = "Get personalized recommendations for all projects"
run = '''
echo "━━━ Drift Next Steps ━━━"
echo ""
echo "→ MCP Catalog"
(cd metorial && drift next-steps) || true
echo ""
echo "→ Platform"
(cd metorial-platform && drift next-steps) || true
echo ""
echo "→ Index Registry"
(cd metorial-index && drift next-steps) || true
'''

# ============================================================================
# Per-Project Drift Scanning (Multi-Project Registration)
# ============================================================================
# Each sub-repo is registered as a separate Drift project with its own .drift/
# Use `drift projects list` to see all registered projects
# Project names: "MCP Catalog", "Platform", "MCP Engine", "Index Registry"

# Per-Project Scanning - Individual project control
# Use drift:scan or drift:scan-full for all projects at once

[tasks."drift:scan-catalog"]
description = "Scan MCP Catalog for patterns"
run = "drift scan -p 'MCP Catalog' --incremental"

[tasks."drift:scan-platform"]
description = "Scan Platform for patterns"
run = "drift scan -p 'Platform' --incremental"

[tasks."drift:scan-engine"]
description = "Scan MCP Engine (Go) for patterns"
run = "drift scan -p 'MCP Engine' --incremental"

[tasks."drift:scan-index"]
description = "Scan Index Registry for patterns"
run = "drift scan -p 'Index Registry' --incremental"

# Per-project status commands
[tasks."drift:status-all"]
description = "Show status for all Metorial projects"
run = '''
echo "━━━ MCP Catalog ━━━"
(cd metorial && drift status)
echo ""
echo "━━━ Platform ━━━"
(cd metorial-platform && drift status)
echo ""
echo "━━━ MCP Engine ━━━"
(cd metorial-platform/src/mcp-engine && drift status)
echo ""
echo "━━━ Index Registry ━━━"
(cd metorial-index && drift status)
'''

[tasks."drift:approve-all"]
description = "Auto-approve patterns ≥90% confidence across all projects"
run = '''
echo "━━━ Approving patterns (≥90% confidence) ━━━"
echo ""
echo "→ MCP Catalog"
(cd metorial && drift approve --auto --threshold 0.90 --yes)
echo ""
echo "→ Platform"
(cd metorial-platform && drift approve --auto --threshold 0.90 --yes)
echo ""
echo "→ MCP Engine"
(cd metorial-platform/src/mcp-engine && drift approve --auto --threshold 0.90 --yes)
echo ""
echo "→ Index Registry"
(cd metorial-index && drift approve --auto --threshold 0.90 --yes)
echo ""
echo "✓ All high-confidence patterns approved"
'''

# Per-project context generation
[tasks."drift:context-catalog"]
description = "Generate AI context for MCP Catalog"
run = "(cd metorial && drift context --format ai --snippets)"

[tasks."drift:context-platform"]
description = "Generate AI context for Platform"
run = "(cd metorial-platform && drift context --format ai --snippets)"

[tasks."drift:context-engine"]
description = "Generate AI context for MCP Engine"
run = "(cd metorial-platform/src/mcp-engine && drift context --format ai --snippets)"

[tasks."drift:context-index"]
description = "Generate AI context for Index Registry"
run = "(cd metorial-index && drift context --format ai --snippets)"

[tasks."drift:build-all"]
description = "Build all Drift analysis data"
depends = ["drift:callgraph", "drift:test-topology", "drift:coupling", "drift:error-handling"]
run = "echo 'All Drift analysis data built'"

# ============================================================================
# DRIFT WATCH MODE - Real-time Pattern Detection
# ============================================================================
# Watch mode monitors file changes and detects patterns in real-time
# Great for development feedback loops

# Watch mode tasks - run from specific project directory
# These monitor file changes in real-time for pattern detection

[tasks."drift:watch-catalog"]
description = "Watch MCP Catalog for real-time pattern detection"
run = "(cd metorial && drift watch)"

[tasks."drift:watch-platform"]
description = "Watch Platform for real-time pattern detection"
run = "(cd metorial-platform && drift watch)"

[tasks."drift:watch-index"]
description = "Watch Index Registry for real-time pattern detection"
run = "(cd metorial-index && drift watch)"

[tasks."drift:watch-verbose-platform"]
description = "Watch Platform with detailed output"
run = "(cd metorial-platform && drift watch --verbose)"

[tasks."drift:watch-api"]
description = "Watch Platform focused on API patterns"
run = "(cd metorial-platform && drift watch --categories api,auth,errors)"

[tasks."drift:watch-security"]
description = "Watch Platform focused on security patterns"
run = "(cd metorial-platform && drift watch --categories auth,security,errors)"

[tasks."drift:watch-context"]
description = "Watch Platform with auto-updated AI context file"
run = "(cd metorial-platform && drift watch --context .drift/CONTEXT.md --verbose)"

[tasks."drift:watch-no-persist"]
description = "Watch Platform without saving patterns (violations only)"
run = "(cd metorial-platform && drift watch --no-persist --verbose)"

# ============================================================================
# DRIFT GIT HOOKS - Pre-commit/Pre-push Integration
# ============================================================================
# Git hooks run Drift checks automatically on commit/push
# Install with: git config core.hooksPath .githooks

[tasks."drift:hooks:install"]
description = "Install Drift git hooks"
run = "git config core.hooksPath .githooks && echo '✓ Git hooks installed (.githooks)'"

[tasks."drift:hooks:uninstall"]
description = "Uninstall Drift git hooks"
run = "git config --unset core.hooksPath && echo '✓ Git hooks uninstalled'"

[tasks."drift:hooks:status"]
description = "Check git hooks installation status"
run = '''
HOOKS_PATH=$(git config core.hooksPath 2>/dev/null || echo "not set")
if [ "$HOOKS_PATH" = ".githooks" ]; then
    echo "✓ Drift git hooks are installed"
    echo "  Hooks path: .githooks"
    ls -la .githooks/*.
else
    echo "✗ Drift git hooks are NOT installed"
    echo "  Run 'mise run drift:hooks:install' to enable"
fi
'''

# ============================================================================
# DRIFT SECURITY BOUNDARIES - Data Access Enforcement
# ============================================================================
# Security boundaries track sensitive data access and enforce rules
# Rules defined in: .drift/boundaries/rules.json

[tasks."drift:boundaries"]
description = "Show data boundaries overview for all projects"
run = '''
echo "━━━ Data Boundaries Overview ━━━"
echo ""
echo "→ MCP Catalog"
(cd metorial && drift boundaries) || true
echo ""
echo "→ Platform"
(cd metorial-platform && drift boundaries) || true
echo ""
echo "→ Index Registry"
(cd metorial-index && drift boundaries) || true
'''

[tasks."drift:boundaries-platform"]
description = "Show Platform data boundaries"
run = "(cd metorial-platform && drift boundaries)"

[tasks."drift:boundaries-tables"]
description = "List all discovered database tables (Platform)"
run = "(cd metorial-platform && drift boundaries tables)"

[tasks."drift:boundaries-sensitive"]
description = "Show all sensitive field access (Platform)"
run = "(cd metorial-platform && drift boundaries sensitive)"

[tasks."drift:boundaries-check"]
description = "Check for boundary violations in all projects"
run = '''
echo "━━━ Boundary Violation Check ━━━"
echo ""
echo "→ MCP Catalog"
(cd metorial && drift boundaries check) || true
echo ""
echo "→ Platform"
(cd metorial-platform && drift boundaries check) || true
echo ""
echo "→ Index Registry"
(cd metorial-index && drift boundaries check) || true
'''

[tasks."drift:boundaries-init"]
description = "Generate starter boundary rules (Platform)"
run = "(cd metorial-platform && drift boundaries init-rules)"

# ============================================================================
# DRIFT TRENDS & DECISION MINING - Historical Analysis
# ============================================================================
# Track pattern health over time and mine decisions from git history

[tasks."drift:trends"]
description = "Show pattern trends for all projects (7-day)"
run = '''
echo "━━━ Pattern Trends (7-day) ━━━"
echo ""
echo "→ MCP Catalog"
(cd metorial && drift trends) || true
echo ""
echo "→ Platform"
(cd metorial-platform && drift trends) || true
echo ""
echo "→ Index Registry"
(cd metorial-index && drift trends) || true
'''

[tasks."drift:trends-30d"]
description = "Show pattern trends over 30 days"
run = '''
echo "━━━ Pattern Trends (30-day) ━━━"
echo ""
echo "→ MCP Catalog"
(cd metorial && drift trends --period 30d) || true
echo ""
echo "→ Platform"
(cd metorial-platform && drift trends --period 30d) || true
echo ""
echo "→ Index Registry"
(cd metorial-index && drift trends --period 30d) || true
'''

[tasks."drift:trends-90d"]
description = "Show pattern trends over 90 days"
run = '''
echo "━━━ Pattern Trends (90-day) ━━━"
echo ""
echo "→ Platform"
(cd metorial-platform && drift trends --period 90d) || true
'''

[tasks."drift:trends-ci"]
description = "Trends analysis for CI (JSON output, Platform)"
run = "(cd metorial-platform && drift trends --format json)"

[tasks."drift:decisions"]
description = "Show mined architectural decisions (Platform)"
run = "(cd metorial-platform && drift decisions)"

[tasks."drift:decisions-generate"]
description = "Generate ADRs from git history (Platform)"
run = "(cd metorial-platform && drift decisions generate-adrs --output docs/decisions)"

# ============================================================================
# DRIFT CONSTANTS & SECRETS ANALYSIS
# ============================================================================
# Find hardcoded values and potential secrets in codebase

[tasks."drift:constants"]
description = "Analyze hardcoded constants in all projects"
run = '''
echo "━━━ Constants Analysis ━━━"
echo ""
echo "→ MCP Catalog"
(cd metorial && drift constants) || true
echo ""
echo "→ Platform"
(cd metorial-platform && drift constants) || true
echo ""
echo "→ Index Registry"
(cd metorial-index && drift constants) || true
'''

[tasks."drift:constants-secrets"]
description = "Find potential hardcoded secrets in all projects"
run = '''
echo "━━━ Secrets Scan ━━━"
echo ""
echo "→ MCP Catalog"
(cd metorial && drift constants --find-secrets) || true
echo ""
echo "→ Platform"
(cd metorial-platform && drift constants --find-secrets) || true
echo ""
echo "→ Index Registry"
(cd metorial-index && drift constants --find-secrets) || true
'''

[tasks."drift:constants-urls"]
description = "Find hardcoded URLs in all projects"
run = '''
echo "━━━ Hardcoded URLs ━━━"
echo ""
echo "→ MCP Catalog"
(cd metorial && drift constants --find-urls) || true
echo ""
echo "→ Platform"
(cd metorial-platform && drift constants --find-urls) || true
echo ""
echo "→ Index Registry"
(cd metorial-index && drift constants --find-urls) || true
'''

# ============================================================================
# DRIFT IMPACT ANALYSIS - Change Risk Assessment
# ============================================================================
# Analyze the impact of code changes before making them

[tasks."drift:impact"]
description = "Analyze impact of staged changes in all projects"
run = '''
echo "━━━ Impact Analysis (Staged Changes) ━━━"
echo ""
echo "→ MCP Catalog"
(cd metorial && drift impact --staged) || true
echo ""
echo "→ Platform"
(cd metorial-platform && drift impact --staged) || true
echo ""
echo "→ Index Registry"
(cd metorial-index && drift impact --staged) || true
'''

[tasks."drift:impact-platform"]
description = "Analyze impact of staged changes (Platform only)"
run = "(cd metorial-platform && drift impact --staged)"

[tasks."drift:impact-file"]
description = "Analyze impact of changes to a specific file"
run = '''
# Determine which project the file belongs to and analyze there
FILE="$1"
if [[ "$FILE" == metorial-platform/* ]]; then
  (cd metorial-platform && drift impact "${FILE#metorial-platform/}")
elif [[ "$FILE" == metorial-index/* ]]; then
  (cd metorial-index && drift impact "${FILE#metorial-index/}")
elif [[ "$FILE" == metorial/* ]]; then
  (cd metorial && drift impact "${FILE#metorial/}")
else
  echo "File must be in metorial/, metorial-platform/, or metorial-index/"
  exit 1
fi
'''
usage = 'arg "<file>" help="File path to analyze impact for (e.g., metorial-platform/src/api/routes.ts)"'

# ============================================================================
# DRIFT QUALITY GATES - Custom Policies
# ============================================================================
# Run quality gates with custom policies

[tasks."drift:gate-security"]
description = "Run security-focused quality gate on all projects"
run = '''
echo "━━━ Security Quality Gate ━━━"
echo ""
echo "→ MCP Catalog"
(cd metorial && drift gate --gates security-boundary --ci --format github) || true
echo ""
echo "→ Platform"
(cd metorial-platform && drift gate --gates security-boundary --ci --format github) || true
echo ""
echo "→ Index Registry"
(cd metorial-index && drift gate --gates security-boundary --ci --format github) || true
'''

[tasks."drift:gate-full"]
description = "Run all quality gates on all projects"
run = '''
echo "━━━ Full Quality Gate ━━━"
echo ""
echo "→ MCP Catalog"
(cd metorial && drift gate --gates all --ci --format github) || true
echo ""
echo "→ Platform"
(cd metorial-platform && drift gate --gates all --ci --format github) || true
echo ""
echo "→ Index Registry"
(cd metorial-index && drift gate --gates all --ci --format github) || true
'''

[tasks."drift:gate-sarif"]
description = "Run quality gate with SARIF output (Platform)"
run = "(cd metorial-platform && drift gate --ci --format sarif -o drift-results.sarif)"

# ============================================================================
# CHANGELOG TASKS - Automated changelog generation via git-cliff
# ============================================================================
# Documentation: https://git-cliff.org/docs/
# Uses Conventional Commits: https://www.conventionalcommits.org/

[tasks."changelog:generate"]
description = "Generate/update workspace changelog"
run = "git cliff -o CHANGELOG.md"

[tasks."changelog:preview"]
description = "Preview changelog changes (dry run)"
run = "git cliff --unreleased --strip header"

[tasks."changelog:latest"]
description = "Show changelog for latest release only"
run = "git cliff --latest --strip header"

[tasks."changelog:platform"]
description = "Generate changelog for metorial-platform"
run = '''
git cliff \
  --include-path "metorial-platform/**/*" \
  --github-repo "jrmatherly/metorial-platform" \
  -o metorial-platform/CHANGELOG.md
'''

[tasks."changelog:catalog"]
description = "Generate changelog for metorial catalog"
run = '''
git cliff \
  --include-path "metorial/**/*" \
  --github-repo "jrmatherly/metorial" \
  -o metorial/CHANGELOG.md
'''

[tasks."changelog:index"]
description = "Generate changelog for metorial-index"
run = '''
git cliff \
  --include-path "metorial-index/**/*" \
  --github-repo "jrmatherly/metorial-index" \
  -o metorial-index/CHANGELOG.md
'''

[tasks."changelog:engine"]
description = "Generate changelog for mcp-engine"
run = '''
git cliff \
  --include-path "metorial-platform/src/mcp-engine/**/*" \
  --github-repo "jrmatherly/metorial-platform" \
  -o metorial-platform/src/mcp-engine/CHANGELOG.md
'''

[tasks."changelog:all"]
description = "Generate changelogs for all projects"
depends = ["changelog:generate", "changelog:platform", "changelog:catalog", "changelog:index"]
run = "echo 'All changelogs generated'"

[tasks."changelog:release"]
description = "Generate release notes for latest tag"
run = "git cliff --latest --strip header -o RELEASE_NOTES.md"

[tasks."changelog:bump"]
description = "Calculate next semantic version based on commits"
run = "git cliff --bumped-version"

[tasks."changelog:validate"]
description = "Validate recent commits follow conventional format"
run = '''
echo "Checking recent commits for conventional format..."
git cliff --unreleased 2>&1 | head -50
echo ""
echo "✓ Changelog preview generated successfully"
'''

# ============================================================================
# MULTI-REPO GIT OPERATIONS (via gita)
# ============================================================================
# These tasks wrap gita commands for team standardization and discoverability
# gita is installed via mise's pipx backend (see [tools] section)

[tasks."git:status"]
description = "Show visual status of all repositories (via gita)"
run = "gita ll"
alias = "gs"

[tasks."git:fetch"]
description = "Fetch all repositories asynchronously (via gita)"
run = "gita fetch"
alias = "gf"

[tasks."git:pull"]
description = "Pull all repositories (via gita)"
run = "gita pull"
alias = "gp"
confirm = "This will pull changes in all repositories. Continue?"

[tasks."git:push"]
description = "Push all repositories (via gita)"
run = "gita push"
confirm = "This will push changes in all repositories. Continue?"

[tasks."git:branches"]
description = "Show branches across all repositories"
run = "gita branch"

[tasks."git:checkout"]
description = "Checkout branch in all repositories"
run = "gita super checkout $1"
usage = 'arg "<branch>" help="Branch name to checkout"'

[tasks."git:stash"]
description = "Stash changes in all repositories"
run = "gita super stash"

[tasks."git:stash-pop"]
description = "Pop stashed changes in all repositories"
run = "gita super stash pop"

# ============================================================================
# SHELL ALIASES
# ============================================================================
# Quick shortcuts when mise shell integration is active
# Usage: Type alias directly in shell (e.g., `mdev` instead of `mise run dev`)

[shell_alias]
# Workspace shortcuts
mdev = "mise run dev"
mbuild = "mise run build"
mtest = "mise run test"
mstatus = "mise run status"
mhealth = "mise run health"

# Platform shortcuts
pdev = "mise run platform:dev"
pbuild = "mise run platform:build"
ptest = "mise run platform:test"

# Engine shortcuts
edev = "mise run engine:dev"
ebuild = "mise run engine:build"
etest = "mise run engine:test"

# Git shortcuts (via gita)
gstatus = "mise run git:status"
gfetch = "mise run git:fetch"
gpull = "mise run git:pull"

# Drift shortcuts
dscan = "mise run drift:scan"
dstatus = "mise run drift:status"
dcheck = "mise run drift:check"
dgate = "mise run drift:gate"
dwatch = "mise run drift:watch"
dbound = "mise run drift:boundaries"
dtrend = "mise run drift:trends"

# Changelog shortcuts
clog = "mise run changelog:preview"
cgen = "mise run changelog:generate"
cbump = "mise run changelog:bump"

