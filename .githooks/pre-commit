#!/usr/bin/env bash
# Drift pre-commit hook - validates staged files against codebase patterns
# Install: git config core.hooksPath .githooks

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}ðŸ” Running Drift pre-commit checks...${NC}"

# Check if drift is available
if ! command -v drift &> /dev/null; then
    echo -e "${YELLOW}âš ï¸  Drift not found, skipping pre-commit checks${NC}"
    echo "   Install with: mise install npm:driftdetect"
    exit 0
fi

# Get list of staged TypeScript/JavaScript files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' || true)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}âœ“ No staged TS/JS files to check${NC}"
    exit 0
fi

# Run drift check on staged files
echo "Checking staged files for pattern violations..."

# Create temporary file list
TEMP_FILE=$(mktemp)
echo "$STAGED_FILES" > "$TEMP_FILE"

# Run drift check with incremental mode
if drift check --staged --fail-on error 2>/dev/null; then
    echo -e "${GREEN}âœ“ All pattern checks passed${NC}"
    rm -f "$TEMP_FILE"
    exit 0
else
    EXIT_CODE=$?
    echo -e "${RED}âœ— Pattern violations detected${NC}"
    echo ""
    echo "Run 'drift check --staged --verbose' for details"
    echo "Or use 'git commit --no-verify' to bypass (not recommended)"
    rm -f "$TEMP_FILE"
    exit $EXIT_CODE
fi
